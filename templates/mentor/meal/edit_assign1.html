{% extends 'base.html' %}
{% load static %}
{% block title %} Assign Meals {% endblock title %}

{% block content %}
{% load custom_filters %}

<div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
    <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <h2 class="text-title-md2 font-semibold text-black dark:text-white">Assign Meals</h2>
        <nav>
            <ol class="flex items-center gap-2">
                <li><a class="font-medium" href="{{dashboard}}">Dashboard /</a></li>
                <li class="font-medium text-primary">Assign Meals</li>
            </ol>
        </nav>
    </div>
    <div class="pb-5">
        <div class="flex justify-between p-3 container bg-white rounded-lg">
          <!-- Left Side (Date and Total Meals) -->
          <div class="left flex items-center">
            <div class="inline-flex items-center gap-2">
              {% comment %} <div class="inline-flex bg-primary text-white font-bold p-2 gap-2 items-center shadow-md">
                Date: <span id="date"></span>
              </div> {% endcomment %}
              {% comment %} <div class="inline-flex bg-meta-3 text-white font-bold p-2 gap-2 items-center shadow-md">
                Total Meals: {{ total_sum }}
              </div> {% endcomment %}
            </div>
          </div>
      
          <!-- Right Side (Back to Homepage Button) -->
          <div>
            <a href="{% url 'dashboard' %}" class="inline-flex items-center gap-2 rounded-md bg-primary my-1 px-6 py-3 font-medium text-white hover:bg-opacity-90">
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" focusable="false" class="chakra-icon css-1q0mvrt" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
                <path d="M48 256c0 114.87 93.13 208 208 208s208-93.13 208-208S370.87 48 256 48 48 141.13 48 256zm224-80.09L208.42 240H358v32H208.42L272 336.09l-22.7 22.54L147.46 256 249.3 153.37z"></path>
              </svg>
              <span>Back to Homepage</span>
            </a>
          </div>
        </div>
      </div>
      
</div>

    
    <!-- Date Picker and Total Meals Button -->
    <td class="w-20 px-6 py-3 flex items-center justify-between mb-2">
        <div
        class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark"
      >
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4">
          <div
            class="flex justify-between border-b border-r border-stroke px-7.5 py-7 dark:border-strokedark xl:border-b-0"
          >
            <div class="flex items-center gap-5.5">
              
    
              <div>
                <p class="text-lg font-medium text-[#9B51E0]">Breakfast</p>
                <span class="font-medium">Quantity: <span id="breakfast">{{order.breakfast}}</span></span>
              </div>
            </div>
    
            <div>
              <p class="mt-1.5 font-medium text-black dark:text-white">
                {% comment %} <span id="breakfastassigned">0</span> assigned {% endcomment %}
              </p>
            </div>
          </div>
    
          <div
            class="flex justify-between border-b border-r border-stroke px-7.5 py-7 dark:border-strokedark xl:border-b-0"
          >
            <div class="flex items-center gap-5.5">
              
    
              <div>
                <p class="text-lg font-medium text-[#219653]">Lunch</p>
                <span class="font-medium">Quantity: <span id="breakfast">{{order.lunch}}</span></span>
              </div>
            </div>
    
            <div>
              <p class="mt-1.5 font-medium text-black dark:text-white">
                {% comment %} <span id="lunchassigned">0</span> assigned {% endcomment %}
              </p>
            </div>
          </div>
    
          <div
            class="flex justify-between border-b border-r border-stroke px-7.5 py-7 dark:border-strokedark sm:border-b-0"
          >
            <div class="flex items-center gap-5.5">
              
    
              <div>
                <p class="text-lg font-medium text-[#2F80ED]">Tea & Snack</p>
                <span class="font-medium">Quantity: <span id="breakfast">{{order.snack}}</span></span>
              </div>
            </div>
    
            <div>
              <p class="mt-1.5 font-medium text-black dark:text-white">
                {% comment %} <span id="snackassigned">0</span> assigned {% endcomment %}
              </p>
            </div>
          </div>
    

          
              <!-- Tea & Snack Section -->
    <div
    class="flex justify-between border-b border-r border-stroke px-7.5 py-7 dark:border-strokedark sm:border-b-0"
  >
    <div class="flex items-center gap-5.5">
      <div>
        <p class="text-lg font-medium text-[#2F80ED]">Dinner</p>
        <span class="font-medium">Dinner  Quantity: <span id="snack">{{ dinner }}</span></span>
      </div>
    </div>
    <div>
      <p class="mt-1.5 font-medium text-black dark:text-white">
        {% comment %} <span id="snackassigned">0</span> assigned {% endcomment %}
      </p>
    </div>
  </div>

      

        </div>
      </div>
      <!-- File Details List End -->
    </td>




 <!-- Header Section -->
 <div class="py-5">
  <div class="flex justify-between p-3 ">
    <!-- Left Side (Date and Total Meals) -->
    <div class="left flex items-center">
      <div class="inline-flex items-center gap-2">
        
        <div class="inline-flex  text-white bg-white font-bold p-2 gap-2 items-center shadow-md">
          <div class="inline-flex bg-primary text-white font-bold p-2 gap-2 items-center shadow-md">
          Date: <span id="date"></span>
        </div>
        <div>
            {% comment %} <label
              class="mb-3 block text-sm font-medium text-black dark:text-white"
            >
              Date picker
            </label> {% endcomment %}
            <div class="relative">
              <input
                id="date"
                class="form-datepicker text-black w-full rounded border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"
                placeholder="mm/dd/yyyy"
                data-class="flatpickr-right"
              />

              <div
                class="pointer-events-none absolute inset-0 left-auto right-5 flex items-center"
              >
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 18 18"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M15.7504 2.9812H14.2879V2.36245C14.2879 2.02495 14.0066 1.71558 13.641 1.71558C13.2754 1.71558 12.9941 1.99683 12.9941 2.36245V2.9812H4.97852V2.36245C4.97852 2.02495 4.69727 1.71558 4.33164 1.71558C3.96602 1.71558 3.68477 1.99683 3.68477 2.36245V2.9812H2.25039C1.29414 2.9812 0.478516 3.7687 0.478516 4.75308V14.5406C0.478516 15.4968 1.26602 16.3125 2.25039 16.3125H15.7504C16.7066 16.3125 17.5223 15.525 17.5223 14.5406V4.72495C17.5223 3.7687 16.7066 2.9812 15.7504 2.9812ZM1.77227 8.21245H4.16289V10.9968H1.77227V8.21245ZM5.42852 8.21245H8.38164V10.9968H5.42852V8.21245ZM8.38164 12.2625V15.0187H5.42852V12.2625H8.38164V12.2625ZM9.64727 12.2625H12.6004V15.0187H9.64727V12.2625ZM9.64727 10.9968V8.21245H12.6004V10.9968H9.64727ZM13.8379 8.21245H16.2285V10.9968H13.8379V8.21245ZM2.25039 4.24683H3.71289V4.83745C3.71289 5.17495 3.99414 5.48433 4.35977 5.48433C4.72539 5.48433 5.00664 5.20308 5.00664 4.83745V4.24683H13.0504V4.83745C13.0504 5.17495 13.3316 5.48433 13.6973 5.48433C14.0629 5.48433 14.3441 5.20308 14.3441 4.83745V4.24683H15.7504C16.0316 4.24683 16.2566 4.47183 16.2566 4.75308V6.94683H1.77227V4.75308C1.77227 4.47183 1.96914 4.24683 2.25039 4.24683ZM1.77227 14.5125V12.2343H4.16289V14.9906H2.25039C1.96914 15.0187 1.77227 14.7937 1.77227 14.5125ZM15.7504 15.0187H13.8379V12.2625H16.2285V14.5406C16.2566 14.7937 16.0316 15.0187 15.7504 15.0187Z"
                    fill="#64748B"
                  />
                </svg>
              </div>
            </div>
            
          </div>
          <div class="inline-flex bg-meta-3 text-white font-bold ml-2 p-2 gap-2 items-center shadow-md">
            Total Meals: {{ total_sum }}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Side (Back to Homepage Button) -->
    
  </div>
</div>
<!-- Addresses Section -->
{% for address in addresses %}
<div class="rounded-sm border border-stroke bg-white px-5 mt-4 pt-6 pb-2.5 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:pb-1">
<h4 class="mb-6 text-xl font-bold text-black dark:text-white">
    {{address}}
</h4>

<div class="flex flex-col">
  <!-- Table Header -->
  <div class="grid grid-cols-3 rounded-sm bg-gray-2 dark:bg-meta-4 sm:grid-cols-3">
    
  <div class="p-2.5 xl:p-5">
      <h5 class="text-sm font-medium uppercase xsm:text-base">Meal Type</h5>
    </div>
    <div class="p-2.5 text-center xl:p-5">
      <h5 class="text-sm font-medium uppercase xsm:text-base">Items</h5>
    </div>
    <div class="p-2.5 text-left text-center xl:p-5">
      <h5 class="text-sm font-medium uppercase xsm:text-base">Quantity</h5>
    </div>
  </div>

  <!-- Table Body -->
  <div class="bg-white dark:bg-boxdark rounded-b-[10px]" id="mealTable">
    {% for meal_type, dishes in day_meals.items %}
    <div class="grid grid-cols-3 border-b border-stroke dark:border-strokedark sm:grid-cols-3">
      <tr style="width:400px">
      <!-- Meal Type Column -->
      <div class="flex items-center gap-3 p-2.5 xl:p-5">
        <p class="font-medium text-black dark:text-white text-center">
          {{ meal_type|capfirst }}
        </p>
        <input type="hidden" id="meal-plan" value="{{ meal_type }}">
      </div>
    </tr>
      <!-- Items Column -->
<!-- Items Column -->
<div class="flex items-center justify-center p-2.5 xl:p-5 min-w-[800px]"> <!-- Set width to 50% -->
  <p class="font-small text-black dark:text-white">
      {% for dish in dishes %}
          <span>
              {% for selected_dish in dish.selected_dishes.all %}
                  {{ selected_dish.dish_name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
          </span>
          {% if not forloop.last %} | {% endif %}
      {% endfor %}
  </p>
</div>

    
    

      <!-- Assign Column -->
      <div class="flex items-center justify-center  ml-4 p-2.5 xl:p-5 text-center" >
        <input 
          type="number" 
          id="quantity" 
          min="0" 
          class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal text-black outline-none transition focus:border-success active:border-success disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-success"
          placeholder="0"
          required 
          value="{% if meal_delivery_data|get_item:address and meal_delivery_data|get_item:address|get_item:meal_type %}{{ meal_delivery_data|get_item:address|get_item:meal_type }}{% else %}0{% endif %}">

        <input type="hidden" id="address" value="{{ address.id }}">
        
      </div>

    </div>
    {% endfor %}
  </div>
</div>
</div>
{% endfor %}

<div class="rounded-sm border border-stroke bg-white px-5 mt-4 p-1 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:pb-1">

  <div class="flex items-center justify-center mt-2 mb-2">
      <button
          id="submitBtn"
          class="bg-meta-3 px-10 py-4 text-white hover:bg-opacity-90 ml-4">
          Submit
      </button>
  </div>
</div>
</div>







<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

  
  // Calculate total quantity across rows and ensure it does not exceed a specified limit
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Check if this cookie string begins with the name we want
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrfToken = getCookie('csrftoken');

  function toast(message) {
    Swal.fire({
      toast: true,
      position: 'top-end',  // Adjust position as needed
      icon: 'success',  // Use 'success', 'error', 'info', 'warning', or 'question'
      title: message,
      showConfirmButton: false,
      timer: 3000,  // Close after 3 seconds
      timerProgressBar: true,
      customClass: {
        popup: 'colored-toast'  // Optional: Custom class for styling
      },
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer);
        toast.addEventListener('mouseleave', Swal.resumeTimer);
      }
    });
  }
  
    // Submit button functionality with AJAX
$('#submitBtn').click(function (e) {
  e.preventDefault(); // Prevent default form submission

  let mealData = $('form').serializeArray();
  $('#mealTable  #tr').each(function () {
     
    const mealPlan = $(this).find('#meal-plan').val();
    let quantity = $(this).find('#quantity').val();
    const address = $(this).find('#address').val();
    const date = $('#date').val();
    if (quantity==""){
        quantity=0;
    }
    mealData.push({
      meal_plan: mealPlan,
      quantity: quantity,
      address: address,
      date:date,
    });
  });

  console.log('Submitting Data:', mealData);

  $.ajax({
      url: "/meal-deliveries/assign-address/post/", // Replace with your endpoint URL
      method: 'POST',
      headers: {
          'X-CSRFToken': csrfToken // Include CSRF token in the request headers
      },
    data: JSON.stringify({mealData:mealData}),
    contentType: 'application/json',
    success: function (response) {
      
     // Append the toast message
      const toastElement = $(toast(response.message));
      // Auto-dismiss toast after 3 seconds and redirect
// Auto-dismiss toast after 3 seconds and redirect
      setTimeout(() => {
       
           
            console.log("Redirecting to /mentor/meals_ordered");
            window.location.href = "/mentor/meals_ordered";
        
      }, 3000);

      
      console.log(response);
    },
    error: function (error) {
      alert('An error occurred while submitting data.');
      console.log(error);
    },
  });
});

</script>
{% endblock content %}
